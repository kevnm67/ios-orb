---
description: |
    Designed as a jobs 1st step to checkout, attach the workspace and install dependencies.

parameters:
    attach_workspace:
        default: false
        description: |
            Whether to attach to an existing workspace.
        type: boolean
    checkout:
        default: false
        description: |
            Whether to checkout as a first step.
        type: boolean
    bundle_install:
        description: Whether to run 'bundle install'.
        type: boolean
        default: true
    ruby-version:
        default: '3.2'
        description: Ruby version to install.
        type: string
    persist_workspace:
        default: true
        description: |
            Whether the job should persist files to a workspace.
        type: boolean
    scripts:
        description: |
            Scripts to run between attaching and saving the
            workspace.  Designed for installing dependencies.
        type: steps
        default: []
    xcode_project:
        description: Name of your xcodeproj for setting the path to the Package.resolved file.
        type: string
        default: ''
    workspace_root:
        default: .
        description: |
            Either an absolute path or a path relative to working_directory.
        type: string
steps:
    - when:
          condition: << parameters.checkout >>
          steps:
              - checkout
    - when:
          condition: << parameters.attach_workspace >>
          steps:
              - attach_workspace:
                    at: .
    - run:
          name: Verify Ruby version
          command: |
              ruby -v || rbenv local $(rbenv versions --bare | tail -1) || rbenv local $(rbenv global)
              ruby -v
              which ruby
    - when:
          condition: << parameters.xcode_project >>
          steps:
              - restore_spm_cache:
                    xcode_project: << parameters.xcode_project >>
    - when:
          condition: << parameters.bundle_install >>
          steps:
              - macos/switch-ruby:
                    version: << parameters.ruby-version >>
              - ruby/install-deps
    - << parameters.scripts >>
    - when:
          condition: << parameters.persist_workspace >>
          steps:
              - persist_to_workspace:
                    root: << parameters.workspace_root >>
                    paths:
                        - .bundle
                        - vendor/bundle
