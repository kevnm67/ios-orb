---
description: |
    Runs tests and uploads results to qlty cloud.
    Note: When using Qlty you *must* (securely) set the QLTY_COVERAGE_TOKEN environment variable.
parameters:
    logs_path:
        description: Path to build logs.
        type: string
        default: ~/Library/Logs/scan
    build_logs_path:
        description: Path to build logs.
        type: string
        default: ~/Library/Logs/DiagnosticReports/
    test_output_path:
        description: Path to test reports.
        type: string
        default: ./fastlane/test_output
    lane:
        description: Lane to run using fastlane.  Only applicable when using fastlane.
        type: string
        default: ''
    pretest_steps:
        description: Scripts to run before starting the test command.
        type: steps
        default: []
    test_steps:
        description: Scripts to run between setting up code climate and uploading the results.
        type: steps
        default: []
    qlty_working_directory:
        description: The directory where to run the Qlty CLI.
        type: string
        default: /Users/distiller/project/
    xcode_project:
        description: Name of your xcodeproj for setting the path to the Package.resolved file.
        type: string
        default: ''

steps:
    - << parameters.pretest_steps >>
    - when:
          condition: << parameters.xcode_project >>
          steps:
              - restore_spm_cache:
                    xcode_project: << parameters.xcode_project >>
    - macos/install-rosetta
    - << parameters.test_steps >>
    - when:
          condition: << parameters.lane >>
          steps:
              - lane:
                    named: << parameters.lane >>
    - when:
          condition: << parameters.xcode_project >>
          steps:
              - cache_spm:
                    xcode_project: << parameters.xcode_project >>
    - qlty/coverage_publish:
          working_directory: << parameters.qlty_working_directory >>
